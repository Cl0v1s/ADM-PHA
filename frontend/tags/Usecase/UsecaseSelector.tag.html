<app-usecaseselector>
    <div each='{ usecase, i in usecases }' data-id="{ i }" onclick="{ show }" class="usecase { usecase.name }">
        { usecase.name }
    </div>
    <div ref="human"></div>
    <script>
        var tag = this; 
        
        tag.usecases = null;
        tag.resident = null;

        tag.human = null;

        tag.on("before-mount", function()
        {
            tag.usecases = tag.opts.usecases;
            if(tag.usecases == null)
                throw new Error("Usecases cant be null.");
            tag.resident = tag.opts.resident;
            if(tag.resident == null)
                throw new Error("Resident cant be null.");
        });

        tag.on("mount", function(){
            tag.human = new Raphael(tag.refs.human, 540, 512);

            let style = {
            fill: "#ddd",
            stroke: "#aaa",
            "stroke-width": 1,
            "stroke-linejoin": "round",
            cursor: "pointer"
            };

            tag.human
            .path("m 69.78125,123.21875 -1.78125,1.375 -4.46875,0.5625 -1,1.375 -3.125,-2.34375 -4.09375,2.75 1.5625,2.125 -2.71875,3.71875 -3.34375,-1.9375 -5.46875,0.1875 0,3.90625 -1.5625,0 -0.375,-1.75 -2.34375,0.375 -0.40625,-4.5 -2.125,2.34375 -2.34375,-0.96875 -4.3125,0.40625 -0.78125,1.9375 -2.53125,0.59375 -0.40625,-2.15625 -4.46875,0.59375 0,1.375 -3.125,0.1875 -1.375,-0.96875 -1.5625,0.78125 -0.40625,2.34375 -5.25,0.1875 -2.75,3.3125 2.34375,1.75 -3.125,2.5625 0.96875,1.75 -0.78125,4.28125 3.125,0.40625 1.1875,-1.1875 0.59375,0.78125 7.40625,-0.96875 4.875,-3.5 -4.28125,4.09375 0.375,1.9375 3.90625,-1.75 -0.78125,2.75 4.3125,0.1875 -0.1875,1.15625 -4.6875,-0.1875 -3.71875,-0.96875 -4.5,-2.15625 -2.71875,3.125 3.5,1.1875 -0.1875,5.25 0.96875,-0.78125 2.15625,-3.3125 4.09375,2.34375 1.96875,0.40625 0.78125,3.125 -1.1875,2.125 -2.53125,-0.1875 -2.34375,0 -3.90625,0.59375 -6.65625,0.375 L 8.84375,166 l 1.9375,1.15625 2.15625,-0.1875 1.75,1.5625 2.53125,-0.1875 4.125,4.6875 0.96875,5.0625 -1.375,2.75 4.09375,0.78125 4.5,-0.21875 0.96875,-1.75 -1.75,-2.34375 1.75,0.78125 1.78125,-0.1875 3.125,1.75 1.9375,-0.375 0,-3.34375 0.78125,3.34375 2.53125,4.09375 5.46875,0.375 0.21875,-1.15625 1.34375,1.9375 3.34375,0.59375 2.53125,0 2.34375,3.71875 3.125,0.78125 1.15625,-1.75 -0.5625,2.125 2.71875,1.1875 3.53125,3.5 1.15625,2.15625 -0.375,2.53125 -0.40625,2.5625 2.34375,1.75 1.1875,-1.375 -1.1875,-1.5625 0,-3.5 2.34375,0.5625 0.78125,-2.34375 0.59375,1.375 2.53125,2.15625 1.1875,-1.96875 -1.1875,-2.71875 L 77,197.25 l 2.71875,-0.40625 -0.5625,-1.375 2.53125,0.59375 1.9375,2.34375 -0.96875,1.5625 -2.53125,-0.78125 -2.9375,-1.375 -1.5625,1.96875 2.34375,0.78125 1.75,2.71875 10.5625,-0.96875 2.71875,0.59375 -1.34375,1.15625 0.1875,1.78125 0.375,0.28125 0.84375,-0.15625 1.75,-1.75 1.15625,1.34375 3.125,0 3.71875,-1.9375 5.46875,-2.15625 0.1875,-5.46875 5.09375,-2.71875 12.09375,-0.59375 0.78125,-2.15625 1.96875,-1.9375 4.28125,-0.59375 0.1875,-2.15625 2.9375,0.40625 1.75,2.34375 3.9375,0.96875 0.75,-1.5625 1,-3.53125 2.53125,-6.25 1.375,-0.78125 3.3125,0.40625 0,-5.28125 -1.375,-1.375 0,-5.65625 -0.59375,-1.9375 0,-3.125 1.96875,-1.96875 0,-3.90625 -0.96875,-0.78125 0.1875,-5.46875 -1.5625,-0.78125 -2.34375,0 -1.96875,-1.5625 -2.125,2.53125 -1.75,0.21875 -1.5625,2.125 -1.5625,-0.375 -3.34375,-2.9375 -1.15625,-3.71875 -0.59375,-2.46875 -9.59375,0 -3.53125,-2.15625 2.34375,-3.125 -4.6875,-0.1875 -3.125,3.53125 -3.71875,-0.40625 -0.375,2.15625 -2.34375,0.1875 -0.1875,-2.71875 -1.96875,-0.59375 -1.375,1.5625 0,-3.90625 -2.34375,1.75 -3.5,-0.59375 -1.1875,2.34375 -7.21875,3.90625 0,1.96875 -1.5625,0 0,-3.53125 -4.09375,-1.9375 0.375,-3.53125 -3.6875,-2.71875 0,-3.3125 -2.75,-0.59375 0.1875,-3.125 -2.125,-0.1875 0.1875,-2.15625 -3.90625,0 -0.59375,1.9375 -1.15625,-2.71875 z")
            .attr(style);
        });

        tag.show = function(event)
        {
            let id = event.target.getAttribute("data-id");
            if(id == null || tag.usecases[id] == null)
                return;
            let allowedTools = [];    
            let requestAllowedTools = App.request(App.Address + "/tool_resident?$filter=Resident_id eq "+tag.resident.id, null, "GET");
            let requestUseCase = App.request(App.Address + "/tool_usecase?$filter=Usecase_id eq "+tag.usecases[id].id, null, "GET");
            let request = Promise.all([requestAllowedTools, requestUseCase]);
            request.then(function(response){ 
                response[1].value.forEach(tool_usecase => {
                    for(let i = 0; i < response[0].value.length; i++)
                    {
                        let tool_resident = response[0].value[i];
                        if(tool_resident.tool.id == tool_usecase.tool.id)
                            allowedTools.push(tool_resident.tool);
                    }
                });
                App.showPopIn("app-usecase", { 
                    "usecase" : tag.usecases[id],
                    "tools" : allowedTools,
                    "resident" : tag.resident
                });
            });
            request.catch(function(error){
                ErrorHandler.alertIfError(error);
            });



        };
    </script>
</app-usecaseselector>