<app-usecaseselector>
    <div each='{ usecase, i in usecases }' data-id="{ i }" onclick="{ show }" class="usecase { usecase.name }">
        { usecase.name }
    </div>
    <div ref="human"></div>
    <script>
        var tag = this; 
        
        tag.usecases = null;
        tag.resident = null;

        tag.human = null;
        tag.bodyparts = [];
        tag.bodypartsPos = [
            {
                x : 0,
                y : 0
            },
            {
                x : 42,
                y : 69
            },
            {
                x : 50,
                y : 143
            },
            {
                x : 68,
                y : 234
            },
            {
                x : 20,
                y : 345
            },
            {
                x : 20,
                y : 436
            }
        ];

        tag.on("before-mount", function()
        {
            tag.usecases = tag.opts.usecases;
            if(tag.usecases == null)
                throw new Error("Usecases cant be null.");
            tag.resident = tag.opts.resident;
            if(tag.resident == null)
                throw new Error("Resident cant be null.");
        });

        tag.on("mount", function(){
            tag.human = new Raphael(tag.refs.human, 540, 512);

            let style = {
            fill: "#ddd",
            stroke: "#aaa",
            "stroke-width": 1,
            "stroke-linejoin": "round",
            cursor: "pointer"
            };

            // Ajout du corps humain
            let body = tag.human
            .path("M154.3,508.3c-1,0-2-0.5-2.6-1.5l-0.3-0.4c-2.1-3-5.2-7.6-6.7-12.1c-0.6-1.7-0.8-2.8-1-3.4\
            c-0.3-1.1-0.3-1.3-1.3-2.7c-1.2-1.6-0.2-5.5,0.6-8.9c0.4-1.7,0.8-3.3,0.8-4.3c0-0.5,0.1-1.1,0.1-1.8l0.1-0.9\
            c0.1-0.8-0.4-1.7-0.9-2.8c-0.7-1.5-1.5-3.4-1.6-5.7c0-1.4,0.4-3,0.8-4.8c0.6-2.6,1.4-5.5,1-8.8c-0.3-3.2-0.7-6.9-1.2-10.9\
            c-1.8-15.7-3.9-35.3-2.9-42.8c1.2-9,1.3-19.5,0.1-24.4c-1.2-5-3.3-31.4-3.6-46.7c-0.3-16.7-3.3-38.8-5.4-40.3\
            c-2.1,1.4-5.1,23.6-5.4,40.3c-0.3,15.3-2.4,41.7-3.6,46.7c-1.1,4.9-1.1,15.3,0.1,24.4c1,7.5-1.2,27.1-2.9,42.8\
            c-0.4,3.9-0.9,7.7-1.2,10.9c-0.3,3,0.8,5.6,1.8,7.8c0.7,1.7,1.4,3.2,1.4,4.7c-0.1,4.3-1.5,7.3-2.6,9.5c-0.6,1.2-1,2.1-1,2.8\
            c0,1,0.4,2.6,0.8,4.3c0.8,3.4,1.8,7.3,0.6,8.9c-1,1.3-1,1.6-1.3,2.7c-0.2,0.7-0.4,1.7-1,3.4c-1.5,4.4-4.6,9-6.7,12.1l-0.3,0.4\
            c-0.7,1-1.6,1.5-2.6,1.5c-1.9,0-3.7-1.7-4-2.9c0-0.2-0.1-0.2-0.3-0.2c-0.3,0-0.7,0.1-1.1,0.3c-0.7,0.2-1.5,0.5-2.3,0.5\
            c-0.5,0-1-0.1-1.4-0.3c-0.6-0.3-1-0.5-1.3-0.6c-0.8-0.4-0.9-0.4-1.3-1l-0.1-0.2c-0.3-0.4-0.8-0.5-1.4-0.6\
            c-0.5-0.1-1-0.2-1.5-0.6c-0.6-0.5-0.9-1.1-1.3-2c-0.2-0.5-0.5-1.1-0.9-1.7c-1-1.8-1.3-2.7-1.1-5.6c0.1-1.7,3.3-5.3,6.7-9.1\
            c2.4-2.7,5-5.5,5.7-7.1c1.6-3.3,1.4-5.5,1.1-10.3c0-0.5-0.1-1.1-0.1-1.7c-0.4-6-4.8-30.1-7.4-39.8c-2.6-9.4-4.4-32.7-2.8-41.8\
            c0.3-1.4,0.5-2.7,0.8-4c1.3-6.9,2.5-12.9,2.1-23.4c-0.4-12.2-0.9-19.2-8.2-46.7c-5.9-22-3.8-43.5-2.6-56.3\
            c0.3-2.7,0.5-5.1,0.6-6.8c0.4-9.2,3.2-19.7,5.9-29.9l0.3-1.1c2.7-10.1,3.9-25.1,3.4-33.9c-0.4-8.3-3.3-14.3-4.6-14.3\
            c-1.4,0.7-3.4,18.6-4.4,27.2l-0.2,1.6c-1.2,10.2-5.7,32.7-9.5,42.9c-1.4,3.6-2.5,6.4-3.4,8.6c-1.6,3.9-2.5,6.2-3,9\
            c-0.3,1.8-0.6,6.2-1,10.7c-0.5,6.6-0.9,13.5-1.7,15.5c-0.4,1-0.7,2.2-1,3.3c-0.7,2.6-1.4,5.3-3.1,7c-1.6,1.6-2.1,1.8-2.9,2\
            c-0.3,0.1-0.6,0.1-1.1,0.3c-0.7,0.3-1.1,1-1.5,1.8c-0.5,0.9-1,1.8-2,2c-0.8,0.1-1.8,1-2.8,1.9c-0.8,0.7-1.8,1.6-2.9,2.3\
            c-0.8,0.5-1.4,0.5-1.8,0c-0.7-0.9-0.3-3.2,0.2-5.1c0.1-0.6,0.1-1.7-0.3-2.1c-0.1-0.2-0.2-0.2-0.3-0.2c-0.1,0-0.4,0.1-0.9,0.5\
            c-0.6,0.6-1.1,0.8-1.6,0.8c-1,0-1.6-1-2-1.7c-0.1-0.2-0.2-0.3-0.2-0.4c-0.4-0.6,0.3-2.7,2.5-9.3c0.9-2.6,1.8-5.4,2.3-7.2\
            c0.9-3.2,0.6-4.6,0.2-5.2c-0.2-0.3-0.4-0.5-0.8-0.5c-0.4,0-1.8,1.9-2.7,3.1c-1.2,1.7-2.4,3.4-3.4,4c-0.5,0.3-1,0.5-1.5,0.5\
            c-0.9,0-1.7-0.5-2-1.1c-0.3-0.6-0.2-1.3,0.2-1.8c1-1.3,6.1-8.9,7.9-12.7c1.3-2.8,4.6-5.2,7-6.9c1-0.7,1.9-1.4,2.4-1.9\
            c1.7-1.7,2.2-6.9,2.5-25.5c0.3-18.5,5.8-40.4,8.7-49.3c2.5-7.6,2.2-18.1,2.1-24.4l0-1c0-1.8,0-3.2-0.1-4.9c0-4.3,0-9.6-0.6-24\
            c-0.8-19.1,11-26.1,17.3-29.9c0.4-0.2,0.7-0.4,1.1-0.6c5.7-3.5,29.4-14,31.9-15.1c0-1.3-0.2-7.5,0-9.1\
            c0.2-1.4-1.7-5.5-2.9-8.3l-0.5-1c-1.1-2.5-0.9-4.7-0.8-5.6l-1.7-0.1c-0.3,0-0.7-0.2-1-0.6c-2-2.4-4.7-12.6-4.6-13.9\
            c0.1-0.7,0.6-1.1,1.4-1.1c0.5,0,1,0.1,1.3,0.2c0-0.6-0.1-1.5-0.2-2.8c-0.7-7.3,2.4-17.1,4.9-21c2.2-3.6,15.2-7.7,15.7-7.9\
            l0.1,0l4,0c0.5,0.2,13.5,4.2,15.7,7.9c2.4,3.9,5.5,13.7,4.9,21c-0.1,1.3-0.2,2.1-0.2,2.8c0.2-0.1,0.8-0.2,1.3-0.2\
            c0.8,0,1.4,0.4,1.4,1.1c0.1,1.4-2.5,11.5-4.6,13.9c-0.3,0.4-0.7,0.6-1,0.6l-1.7,0.1c0.1,0.9,0.3,3.1-0.8,5.6l-0.5,1\
            c-1.3,2.7-3.2,6.9-2.9,8.3c0.3,1.5,0.1,7.7,0,9.1c2.5,1.1,26.2,11.6,31.9,15.1c0.3,0.2,0.7,0.4,1.1,0.6\
            c6.3,3.8,18.1,10.9,17.3,29.9c-0.6,14.4-0.6,19.7-0.6,24c0,1.7,0,3.1-0.1,4.9l0,1c-0.1,6.3-0.4,16.8,2.1,24.4\
            c2.9,9,8.4,30.8,8.7,49.3c0.3,18.6,0.8,23.9,2.5,25.5c0.5,0.5,1.4,1.1,2.4,1.9c2.4,1.8,5.7,4.2,7,6.9c1.8,3.8,7,11.4,7.9,12.7\
            c0.4,0.6,0.5,1.2,0.2,1.8c-0.4,0.7-1.1,1.1-2,1.1c-0.5,0-1-0.2-1.5-0.5c-1-0.6-2.2-2.3-3.4-4c-0.9-1.2-2.2-3.1-2.7-3.1\
            c-0.3,0.1-0.6,0.2-0.8,0.5c-0.4,0.6-0.6,2,0.2,5.2c0.5,1.8,1.4,4.5,2.3,7.2c2.2,6.6,2.9,8.8,2.5,9.3c-0.1,0.1-0.2,0.3-0.2,0.4\
            c-0.4,0.7-1,1.7-2,1.7c-0.5,0-1-0.3-1.6-0.8c-0.5-0.5-0.8-0.5-0.9-0.5c-0.1,0-0.2,0-0.3,0.2c-0.3,0.4-0.4,1.5-0.3,2.1\
            c0.5,1.8,0.9,4.2,0.2,5.1c-0.4,0.5-1,0.5-1.8,0c-1.1-0.7-2.1-1.6-2.9-2.3c-1.1-0.9-2-1.8-2.8-1.9c-1-0.2-1.5-1.1-2-2\
            c-0.4-0.7-0.8-1.5-1.5-1.8c-0.5-0.2-0.8-0.3-1.1-0.3c-0.8-0.2-1.3-0.3-2.9-2c-1.7-1.7-2.4-4.4-3.1-7c-0.3-1.1-0.6-2.3-1-3.3\
            c-0.7-2-1.2-8.9-1.7-15.5c-0.3-4.6-0.6-8.9-1-10.7c-0.5-2.8-1.5-5.1-3-9c-0.9-2.2-2-5-3.4-8.6c-3.8-10.1-8.3-32.6-9.5-42.9\
            l-0.2-1.6c-1-8.6-3.1-26.4-4.5-27.2c-1.3,0-4.2,6.1-4.6,14.3c-0.4,8.7,0.7,23.8,3.4,33.9l0.3,1.1c2.7,10.1,5.5,20.6,5.9,29.9\
            c0.1,1.7,0.3,4.1,0.6,6.8c1.2,12.8,3.2,34.3-2.6,56.3c-7.3,27.5-7.8,34.5-8.2,46.7c-0.3,10.5,0.8,16.5,2.1,23.4\
            c0.2,1.3,0.5,2.6,0.8,4c1.7,9.2-0.2,32.4-2.8,41.8c-2.6,9.8-7,33.8-7.4,39.8c0,0.6-0.1,1.2-0.1,1.7c-0.4,4.9-0.5,7.1,1.1,10.3\
            c0.8,1.6,3.3,4.4,5.8,7.1c3.4,3.8,6.6,7.3,6.7,9.1c0.1,2.9-0.1,3.8-1.1,5.6c-0.4,0.6-0.6,1.2-0.9,1.7c-0.4,0.9-0.7,1.5-1.3,2\
            c-0.4,0.4-1,0.5-1.5,0.6c-0.6,0.1-1.1,0.2-1.4,0.6l-0.1,0.2c-0.4,0.6-0.5,0.6-1.3,1c-0.3,0.1-0.7,0.3-1.3,0.6\
            c-0.4,0.2-0.9,0.3-1.4,0.3c-0.8,0-1.6-0.3-2.3-0.5c-0.4-0.1-0.9-0.3-1.1-0.3c-0.2,0-0.2,0-0.3,0.2\
            C158,506.6,156.2,508.3,154.3,508.3z")
            .attr(style);

            tag.bodyparts = [];

            for(let i = 5; i < tag.usecases.length; i++)
            {
                let part = tag.human.set();
                part.push(
                    tag.human.path("M285.8,28.8c-6.9,0-12.5,5.6-12.5,12.5s5.6,12.5,12.5,12.5s12.5-5.6,12.5-12.5S292.7,28.8,285.8,28.8z M285.8,52.2 c-6,0-11-4.9-11-11s4.9-11,11-11c6,0,11,4.9,11,11S291.8,52.2,285.8,52.2z"),            tag.human.circle(286, 36.3, 1.3)
                    ,tag.human.path("M285.6,39.7c-0.4,0-0.8,0.3-0.8,0.8V47c0,0.4,0.3,0.8,0.8,0.8s0.8-0.3,0.8-0.8v-6.5C286.4,40,286,39.7,285.6,39.7z")
                    ,tag.human.path("M150,57L298,57")
                    ,tag.human.text(182,48, tag.usecases[i].name)
                );
                part.attr(style);
                part.click(function(){ alert("ok");});
                part.translate(tag.bodypartsPos[ i - 5 ].x, tag.bodypartsPos[ i - 5 ].y);
                tag.bodyparts.push(part);
            }




        });

        tag.show = function(event)
        {
            let id = event.target.getAttribute("data-id");
            if(id == null || tag.usecases[id] == null)
                return;
            let allowedTools = [];    
            let requestAllowedTools = App.request(App.Address + "/tool_resident?$filter=Resident_id eq "+tag.resident.id, null, "GET");
            let requestUseCase = App.request(App.Address + "/tool_usecase?$filter=Usecase_id eq "+tag.usecases[id].id, null, "GET");
            let request = Promise.all([requestAllowedTools, requestUseCase]);
            request.then(function(response){ 
                response[1].value.forEach(tool_usecase => {
                    for(let i = 0; i < response[0].value.length; i++)
                    {
                        let tool_resident = response[0].value[i];
                        if(tool_resident.tool.id == tool_usecase.tool.id)
                            allowedTools.push(tool_resident.tool);
                    }
                });
                App.showPopIn("app-usecase", { 
                    "usecase" : tag.usecases[id],
                    "tools" : allowedTools,
                    "resident" : tag.resident
                });
            });
            request.catch(function(error){
                ErrorHandler.alertIfError(error);
            });



        };
    </script>
</app-usecaseselector>